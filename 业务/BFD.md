## BFD（双向转发检测）

> 作者：harfe

BFD可以对系统之间、同一路径上的一种数据协议的连通性进行检测。路径可以是物理链路或者逻辑链路，也包括隧道，当BFD发现系统之间的通信故障数，通知上层应用。

BFD报文封装在UDP报文中进行传送。目的端口号为：**3784** ，源端口号在**49152**到**65535**范围之间。

BFD回话建立的两种机制

- 静态建立BFD会话：通过手工配置BFD会话参数，包括本地标识符和远端标识符。
- 动态建立BFD会话：系统自动分配动态会话标识符区域的值作为BFD会话的本地标识符，然后与对方进行协商。对端收到协商报文判断是否与本地BFD会话匹配，如果匹配，则自动学习远端会话标识符。

设备支持的BFD应用类型：

- 基于IP链路的BFD：在IP链路上建立BFD会话，利用BFD检测机制快速检测故障。设备支持对IP链路进行单跳IP检测或多跳IP检测。
- 基于LSP的BFD：在LSP链路上建立BFD会话，利用BFD检测机制快速检测LSP链路的故障，可以提供端到端的保护。
- 基于PW的BFD：是一种针对L2VPN网络进行故障检测的机制，L2VPN利用BFD完成隧道或PW故障的快速检测，从而引导所承载业务的快速切换，达到业务保护的目的。

BFD的两种操作模式：

- 异步模式
- 查询模式

BFD会话建立前，BFD控制报文以1s的时间间隔周期性发送，以减小报文流量。BFD会话建立之后，BFD控制报文发送时间间隔由本端和对端中较慢的一方决定发送频率。

BFD中**没有发现机制**，由程序决定是否需要使用BFD，以及将要使用的地址。

Echo功能

BFD Echo报文采用UDP封装，目的端口号为**3785**。

当Echo功能激活时，BFD数据流以使另一个系统通过其转发路径将其环回的方式传输。如果未接收到回送数据流的多个分组，则会话被申明为关闭。

在Echo功能激活时，由于echo功能正在检测任务，因此控制数据包的周期传输速率可能会降低或者完全消除。



### CTC8180

SBFD双向转发检测：为简化协商，简单化状态机，适合应用于一个Server多个Client的应用场景。

对于SBFD，状态机没有init状态，只有down和up状态，即down收到up报文就会将状态置为up状态。

SBFD Initiator特点：

- 主动发送BFD控制报文，维护更新状态机，发起协商
- 发送的报文D = 1
- 应用于IP BFD场景：TTL = 255
- 应用于MPLS BFD场景：最外层label的TTL = 255；IP header的IPDA是127/8或者0:0:0:0:0:ffff:7f00:0/104并且TTL = 1

SBFD Reflector特点：

- ​